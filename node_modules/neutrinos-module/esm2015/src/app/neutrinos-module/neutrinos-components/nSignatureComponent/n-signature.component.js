import { Component, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import * as signing from 'signature_pad';
export class NSignatureComponent {
    constructor() {
        this.imageDataValue = '';
        this.signaturePad = '';
        this.mode = 'responsive'; // 'click-fullscreen' or 'responsive'
        this.canvasMode = 'fullscreen'; // 'responsive' or 'fullscreen'
        this.imageDataChange = new EventEmitter();
        this.imageDataUrl = new EventEmitter();
    }
    get imageData() {
        return this.imageDataValue;
    }
    set imageData(val) {
        var _a;
        this.imageDataValue = JSON.parse(JSON.stringify(val));
        if ((_a = this.signaturePad) === null || _a === void 0 ? void 0 : _a.canvas) {
            this.saveFromSavedData(this.imageDataValue);
            if (this.mode !== 'responsive') {
                this.imageSrcDataUrl = this.signaturePad.toDataURL();
            }
        }
    }
    ngOnInit() {
        this.savedDataPoints = this.previousSavedData = JSON.parse(JSON.stringify(this.imageData));
    }
    ngAfterViewInit() {
        this.createCanvas();
        this.saveFromSavedData(this.savedDataPoints);
        setTimeout(() => {
            if (this.mode !== 'responsive') {
                this.hideCanvas();
                this.fitToContainer(this.signaturecanvas.nativeElement, document.body.clientHeight, document.body.clientWidth);
                this.clearCanvas();
                this.drawFromSavedData(this.savedDataPoints);
                this.imageSrcDataUrl = this.signaturePad.toDataURL();
            }
        });
    }
    saveFromSavedData(val) {
        this.updatePreviousSaveData(val);
        this.drawFromSavedData(val);
        this.savedDataPoints = this.signaturePad.toData();
    }
    createCanvas() {
        this.fitToContainer(this.signaturecanvas.nativeElement);
        this.signaturePad = new signing.default(this.signaturecanvas.nativeElement, this.assignOptions());
    }
    saveCavas() {
        if (this.signaturePad) {
            if (this.signaturePad.isEmpty()) {
                this.clearCanvas();
            }
            this.imageDataChange.emit(JSON.parse(JSON.stringify(this.signaturePad.toData())));
            this.imageDataUrl.emit(this.signaturePad.toDataURL());
            if (this.mode !== 'responsive') {
                this.hideCanvas();
                this.imageSrcDataUrl = this.signaturePad.toDataURL();
            }
            this.saveFromSavedData(this.signaturePad.toData());
        }
    }
    clearCanvas() {
        this.signaturePad.clear();
    }
    undoCanvas() {
        const data = this.signaturePad.toData();
        if (data) {
            data.pop(); // remove the last dot or line
            this.signaturePad.fromData(data);
        }
    }
    showCanvas() {
        this.classAbs = true;
        this.canvasMode = 'fullscreen';
        if (!this.signaturePad) {
            this.createCanvas();
        }
        this.fitToContainer(this.signaturecanvas.nativeElement, document.body.clientHeight, document.body.clientWidth);
        this.clearCanvas();
        this.updatePreviousSaveData(this.savedDataPoints);
        this.drawFromSavedData(this.savedDataPoints);
    }
    hideCanvas() {
        this.canvasMode = 'responsive';
    }
    // cancel currently drawn
    cancel() {
        this.savedDataPoints = Object.assign([], this.previousSavedData);
        this.clearCanvas();
        this.drawFromSavedData(this.savedDataPoints);
    }
    updatePreviousSaveData(val) {
        this.previousSavedData = Object.assign([], val);
    }
    drawFromSavedData(val) {
        if (val) {
            this.signaturePad.clear();
            this.signaturePad.fromData(val);
        }
    }
    fitToContainer(element, height, width) {
        element.style.width = '100%';
        element.style.height = 'calc(100% - 56px)';
        if (height && width) {
            element.width = width;
            element.height = height - 56;
        }
        else {
            element.width = element.offsetWidth;
            element.height = element.offsetHeight;
        }
    }
    assignOptions() {
        let options = {};
        options['backgroundColor'] = this.checkIfValidValueAndRGB(this.backgroundColor, 'backgroundColor');
        options['dotSize'] = this.checkIfValidValueAndNumber(this.dotSize, 'dotSize');
        options['minWidth'] = this.checkIfValidValueAndNumber(this.minWidth, 'minWidth');
        options['maxWidth'] = this.checkIfValidValueAndNumber(this.maxWidth, 'maxWidth');
        options['throttle'] = this.checkIfValidValueAndNumber(this.throttle, 'throttle');
        options['minDistance'] = this.checkIfValidValueAndNumber(this.minDistance, 'minDistance');
        options['penColor'] = this.checkIfValidValueAndRGB(this.penColor, 'penColor');
        options['velocityFilterWeight'] = this.checkIfValidValueAndNumber(this.velocityFilterWeight, 'velocityFilterWeight');
        options = JSON.parse(JSON.stringify(options)); // removing all undefined fields
        options['onBegin'] = this.checkIfValidValueAndFunction(this.onBegin, 'onBegin');
        options['onEnd'] = this.checkIfValidValueAndFunction(this.onEnd, 'onEnd');
        return options;
    }
    checkIfValidValueAndNumber(num, name) {
        if (this.checkIfValid(num) && this.checkNumber(num)) {
            return num;
        }
        this.invalidToast(name, 'num');
        return undefined;
    }
    checkIfValidValueAndRGB(color, name) {
        if (this.checkIfValid(color) && this.checkRGB(color)) {
            return color;
        }
        this.invalidToast(name, 'rgb');
        return undefined;
    }
    checkIfValidValueAndFunction(fn, name) {
        if (this.checkIfValid(fn) && this.checkIfValidFunction(fn)) {
            return fn;
        }
        this.invalidToast(name, 'function format');
        return undefined;
    }
    checkIfValid(value) {
        return value !== undefined && value !== null ? value : undefined;
    }
    checkNumber(num) {
        return !this.checkIsNan(Number(num)) ? Number(num) : undefined;
    }
    checkIfValidFunction(fn) {
        return typeof fn === 'function' ? fn : undefined;
    }
    checkRGB(color) {
        const matchColors1 = new RegExp(/rgb\((\d{1,3}),(\d{1,3}),(\d{1,3})\)/);
        const matchColors2 = new RegExp(/rgb\((\d{1,3}),[ \t]+(\d{1,3}),(\d{1,3})\)/);
        const matchColors3 = new RegExp(/rgb\((\d{1,3}),(\d{1,3}),[ \t]+(\d{1,3})\)/);
        return matchColors1.test(color) || matchColors2.test(color) || matchColors3.test(color);
    }
    checkIsNan(value) {
        return Number.isNaN(value);
    }
    invalidToast(optionName, optionType) {
        switch (optionType) {
            case 'num':
                // this.snackbar.open(`Invalid ${optionName} (number or float) given, taking default value instead.`, 'OK');
                break;
            case 'rgb':
                // this.snackbar.open(`Invalid ${optionName} format Eg: rgb(255, 255, 255)  given, taking default value instead.`, 'OK');
                break;
        }
        return;
    }
    isDataURL(s) {
        if (s && typeof s === 'string') {
            const regex = /^\s*data:([a-z]+\/[a-z]+(;[a-z\-]+\=[a-z\-]+)?)?(;base64)?,[a-z0-9\!\$\&\'\,\(\)\*\+\,\;\=\-\.\_\~\:\@\/\?\%\s]*\s*$/i;
            return !!s.match(regex);
        }
        else {
            return false;
        }
    }
}
NSignatureComponent.decorators = [
    { type: Component, args: [{
                selector: 'n-signature',
                template: "<div style=\"width: 100%; height: 100%\">\n\t<div fxFill fxLayout=\"row\" *ngIf=\"mode === 'click-fullscreen' && canvasMode !== 'fullscreen'\" class=\"signature-component-border\">\n\t\t<div fxFlex=\"calc(100%-56px)\" fxLayout=\"column\">\n\t\t\t<img *ngIf=\"imageSrcDataUrl\" [src]=\"imageSrcDataUrl\" fxFill />\n\t\t</div>\n\t\t<div fxFlex=\"56px\" fxLayoutAlign=\" center\" class=\"signature-component-border\">\n\t\t\t<button mat-icon-button (click)=\"showCanvas()\">\n\t\t\t\t<mat-icon>mode_edit</mat-icon>\n\t\t\t</button>\n\t\t</div>\n\t</div>\n\t<div\n\t\tfxFill\n\t\tfxLayout=\"column\"\n\t\tclass=\"signature-component-border\"\n\t\t[fxShow]=\"(mode === 'click-fullscreen' && canvasMode === 'fullscreen') || mode === 'responsive'\"\n\t\t[ngClass]=\"{'signature-canvas-fullscreen': classAbs}\"\n\t>\n\t\t<canvas #signaturecanvas></canvas>\n\t\t<div fxFlex=\"56px\" fxLayoutAlign=\"center center\" class=\"signature-component-border\">\n\t\t\t<button mat-icon-button (click)=\"undoCanvas()\">\n\t\t\t\t<mat-icon>undo</mat-icon>\n\t\t\t</button>\n\t\t\t<button mat-icon-button (click)=\"clearCanvas()\">\n\t\t\t\t<mat-icon>loop</mat-icon>\n\t\t\t</button>\n\t\t\t<button mat-icon-button (click)=\"saveCavas()\">\n\t\t\t\t<mat-icon>save</mat-icon>\n\t\t\t</button>\n\t\t\t<button mat-icon-button (click)=\"canvasMode = 'responsive'; cancel()\">\n\t\t\t\t<mat-icon>clear</mat-icon>\n\t\t\t</button>\n\t\t</div>\n\t</div>\n</div>\n",
                styles: [`
			:host {
				height: 100% !important;
			}
			.signature-canvas-fullscreen {
				position: absolute;
				top: 0;
				bottom: 0;
				right: 0;
				left: 0;
			}
			.signature-component-border {
				border: 2px solid black;
			}
		`]
            },] }
];
NSignatureComponent.propDecorators = {
    signaturecanvas: [{ type: ViewChild, args: ['signaturecanvas', { static: false },] }],
    canvasparent: [{ type: ViewChild, args: ['canvasparent', { static: false },] }],
    backgroundColor: [{ type: Input, args: ['backgroundColor',] }],
    dotSize: [{ type: Input, args: ['dotSize',] }],
    minWidth: [{ type: Input, args: ['minWidth',] }],
    maxWidth: [{ type: Input, args: ['maxWidth',] }],
    throttle: [{ type: Input, args: ['throttle',] }],
    minDistance: [{ type: Input, args: ['minDistance',] }],
    penColor: [{ type: Input, args: ['penColor',] }],
    velocityFilterWeight: [{ type: Input, args: ['velocityFilterWeight',] }],
    onBegin: [{ type: Input, args: ['onBegin',] }],
    onEnd: [{ type: Input, args: ['onEnd',] }],
    mode: [{ type: Input, args: ['mode',] }],
    imageDataChange: [{ type: Output }],
    imageDataUrl: [{ type: Output }],
    imageData: [{ type: Input }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1zaWduYXR1cmUuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2FwcC9uZXV0cmlub3MtbW9kdWxlL25ldXRyaW5vcy1jb21wb25lbnRzL25TaWduYXR1cmVDb21wb25lbnQvbi1zaWduYXR1cmUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBaUIsU0FBUyxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQVUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN6RyxPQUFPLEtBQUssT0FBTyxNQUFNLGVBQWUsQ0FBQztBQXVCekMsTUFBTSxPQUFPLG1CQUFtQjtJQXJCaEM7UUFzQkMsbUJBQWMsR0FBRyxFQUFFLENBQUM7UUFDWixpQkFBWSxHQUFRLEVBQUUsQ0FBQztRQWVoQixTQUFJLEdBQUcsWUFBWSxDQUFDLENBQUMscUNBQXFDO1FBQ3pFLGVBQVUsR0FBRyxZQUFZLENBQUMsQ0FBQywrQkFBK0I7UUFNaEQsb0JBQWUsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ3JDLGlCQUFZLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztJQTJNN0MsQ0FBQztJQTFNQSxJQUNJLFNBQVM7UUFDWixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUM7SUFDNUIsQ0FBQztJQUVELElBQUksU0FBUyxDQUFDLEdBQUc7O1FBQ2hCLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDdEQsVUFBSSxJQUFJLENBQUMsWUFBWSwwQ0FBRSxNQUFNLEVBQUU7WUFDOUIsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUM1QyxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssWUFBWSxFQUFFO2dCQUMvQixJQUFJLENBQUMsZUFB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aEIsS0FBSyxTQUFDLFVBQVU7MEJBQ2hCLEtBQUssU0FBQyxhQUFhO3VCQUNuQixLQUFLLFNBQUMsVUFBVTttQ0FDaEIsS0FBSyxTQUFDLHNCQUFzQjtzQkFDNUIsS0FBSyxTQUFDLFNBQVM7b0JBQ2YsS0FBSyxTQUFDLE9BQU87bUJBQ2IsS0FBSyxTQUFDLE1BQU07OEJBT1osTUFBTTsyQkFDTixNQUFNO3dCQUNOLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZnRlclZpZXdJbml0LCBDb21wb25lbnQsIEV2ZW50RW1pdHRlciwgSW5wdXQsIE9uSW5pdCwgT3V0cHV0LCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCAqIGFzIHNpZ25pbmcgZnJvbSAnc2lnbmF0dXJlX3BhZCc7XG5cbkBDb21wb25lbnQoe1xuXHRzZWxlY3RvcjogJ24tc2lnbmF0dXJlJyxcblx0dGVtcGxhdGVVcmw6ICcuL24tc2lnbmF0dXJlLnRlbXBsYXRlLmh0bWwnLFxuXHRzdHlsZXM6IFtcblx0XHRgXG5cdFx0XHQ6aG9zdCB7XG5cdFx0XHRcdGhlaWdodDogMTAwJSAhaW1wb3J0YW50O1xuXHRcdFx0fVxuXHRcdFx0LnNpZ25hdHVyZS1jYW52YXMtZnVsbHNjcmVlbiB7XG5cdFx0XHRcdHBvc2l0aW9uOiBhYnNvbHV0ZTtcblx0XHRcdFx0dG9wOiAwO1xuXHRcdFx0XHRib3R0b206IDA7XG5cdFx0XHRcdHJpZ2h0OiAwO1xuXHRcdFx0XHRsZWZ0OiAwO1xuXHRcdFx0fVxuXHRcdFx0LnNpZ25hdHVyZS1jb21wb25lbnQtYm9yZGVyIHtcblx0XHRcdFx0Ym9yZGVyOiAycHggc29saWQgYmxhY2s7XG5cdFx0XHR9XG5cdFx0YCxcblx0XSxcbn0pXG5leHBvcnQgY2xhc3MgTlNpZ25hdHVyZUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCB7XG5cdGltYWdlRGF0YVZhbHVlID0gJyc7XG5cdHByaXZhdGUgc2lnbmF0dXJlUGFkOiBhbnkgPSAnJztcblxuXHRAVmlld0NoaWxkKCdzaWduYXR1cmVjYW52YXMnLCB7IHN0YXRpYzogZmFsc2UgfSkgc2lnbmF0dXJlY2FudmFzO1xuXHRAVmlld0NoaWxkKCdjYW52YXNwYXJlbnQnLCB7IHN0YXRpYzogZmFsc2UgfSkgY2FudmFzcGFyZW50O1xuXG5cdEBJbnB1dCgnYmFja2dyb3VuZENvbG9yJykgYmFja2dyb3VuZENvbG9yO1xuXHRASW5wdXQoJ2RvdFNpemUnKSBkb3RTaXplOyAvLyAoZmxvYXQgb3IgZnVuY3Rpb24pIFJhZGl1cyBvZiBhIHNpbmdsZSBkb3QuXG5cdEBJbnB1dCgnbWluV2lkdGgnKSBtaW5XaWR0aDsgLy8gKGZsb2F0KSBNaW5pbXVtIHdpZHRoIG9mIGEgbGluZS4gRGVmYXVsdHMgdG8gMC41LlxuXHRASW5wdXQoJ21heFdpZHRoJykgbWF4V2lkdGg7IC8vIChmbG9hdCkgTWF4aW11bSB3aWR0aCBvZiBhIGxpbmUuIERlZmF1bHRzIHRvIDIuNS5cblx0QElucHV0KCd0aHJvdHRsZScpIHRocm90dGxlOyAvLyAoaW50ZWdlcikgRHJhdyB0aGUgbmV4dCBwb2ludCBhdCBtb3N0IG9uY2UgcGVyIGV2ZXJ5IHggbWlsbGlzZWNvbmRzLiBTZXQgaXQgdG8gMCB0byB0dXJuIG9mZiB0aHJvdHRsaW5nLiBEZWZhdWx0cyB0byAxNi5cblx0QElucHV0KCdtaW5EaXN0YW5jZScpIG1pbkRpc3RhbmNlOyAvLyAoaW50ZWdlcikgQWRkIHRoZSBuZXh0IHBvaW50IG9ubHkgaWYgdGhlIHByZXZpb3VzIG9uZSBpcyBmYXJ0aGVyIHRoYW4geCBwaXhlbHMuIERlZmF1bHRzIHRvIDUuXG5cdEBJbnB1dCgncGVuQ29sb3InKSBwZW5Db2xvcjsgLy8gKHN0cmluZykgQ29sb3IgdXNlZCB0byBjbGVhciB0aGUgYmFja2dyb3VuZC4gQ2FuIGJlIGFueSBjb2xvciBmb3JtYXQgYWNjZXB0ZWQgYnkgY29udGV4dC5maWxsU3R5bGUuIERlZmF1bHRzIHRvIFwicmdiYSgwLDAsMCwwKVwiICh0cmFuc3BhcmVudCBibGFjaykuIFVzZSBhIG5vbi10cmFuc3BhcmVudCBjb2xvciBlLmcuIFwicmdiKDI1NSwyNTUsMjU1KVwiIChvcGFxdWUgd2hpdGUpIGlmIHlvdSdkIGxpa2UgdG8gc2F2ZSBzaWduYXR1cmVzIGFzIEpQRUcgaW1hZ2VzLlxuXHRASW5wdXQoJ3ZlbG9jaXR5RmlsdGVyV2VpZ2h0JykgdmVsb2NpdHlGaWx0ZXJXZWlnaHQ7IC8vIChmbG9hdCkgV2VpZ2h0IHVzZWQgdG8gbW9kaWZ5IG5ldyB2ZWxvY2l0eSBiYXNlZCBvbiB0aGUgcHJldmlvdXMgdmVsb2NpdHkuIERlZmF1bHRzIHRvIDAuNy5cblx0QElucHV0KCdvbkJlZ2luJykgb25CZWdpbjsgLy8gKGZ1bmN0aW9uKSBDYWxsYmFjayB3aGVuIHN0cm9rZSBiZWdpbi5cblx0QElucHV0KCdvbkVuZCcpIG9uRW5kOyAvLyAoZnVuY3Rpb24pIENhbGxiYWNrIHdoZW4gc3Ryb2tlIGVuZC5cblx0QElucHV0KCdtb2RlJykgbW9kZSA9ICdyZXNwb25zaXZlJzsgLy8gJ2NsaWNrLWZ1bGxzY3JlZW4nIG9yICdyZXNwb25zaXZlJ1xuXHRjYW52YXNNb2RlID0gJ2Z1bGxzY3JlZW4nOyAvLyAncmVzcG9uc2l2ZScgb3IgJ2Z1bGxzY3JlZW4nXG5cdHByaXZhdGUgc2F2ZWREYXRhUG9pbnRzO1xuXHRwcml2YXRlIHByZXZpb3VzU2F2ZWREYXRhO1xuXHRjbGFzc0Ficztcblx0aW1hZ2VTcmNEYXRhVXJsO1xuXG5cdEBPdXRwdXQoKSBpbWFnZURhdGFDaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cdEBPdXRwdXQoKSBpbWFnZURhdGFVcmwgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cdEBJbnB1dCgpXG5cdGdldCBpbWFnZURhdGEoKSB7XG5cdFx0cmV0dXJuIHRoaXMuaW1hZ2VEYXRhVmFsdWU7XG5cdH1cblxuXHRzZXQgaW1hZ2VEYXRhKHZhbCkge1xuXHRcdHRoaXMuaW1hZ2VEYXRhVmFsdWUgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHZhbCkpO1xuXHRcdGlmICh0aGlzLnNpZ25hdHVyZVBhZD8uY2FudmFzKSB7XG5cdFx0XHR0aGlzLnNhdmVGcm9tU2F2ZWREYXRhKHRoaXMuaW1hZ2VEYXRhVmFsdWUpO1xuXHRcdFx0aWYgKHRoaXMubW9kZSAhPT0gJ3Jlc3BvbnNpdmUnKSB7XG5cdFx0XHRcdHRoaXMuaW1hZ2VTcmNEYXRhVXJsID0gdGhpcy5zaWduYXR1cmVQYWQudG9EYXRhVVJMKCk7XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG5cblx0bmdPbkluaXQoKSB7XG5cdFx0dGhpcy5zYXZlZERhdGFQb2ludHMgPSB0aGlzLnByZXZpb3VzU2F2ZWREYXRhID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGlzLmltYWdlRGF0YSkpO1xuXHR9XG5cblx0bmdBZnRlclZpZXdJbml0KCkge1xuXHRcdHRoaXMuY3JlYXRlQ2FudmFzKCk7XG5cdFx0dGhpcy5zYXZlRnJvbVNhdmVkRGF0YSh0aGlzLnNhdmVkRGF0YVBvaW50cyk7XG5cdFx0c2V0VGltZW91dCgoKSA9PiB7XG5cdFx0XHRpZiAodGhpcy5tb2RlICE9PSAncmVzcG9uc2l2ZScpIHtcblx0XHRcdFx0dGhpcy5oaWRlQ2FudmFzKCk7XG5cdFx0XHRcdHRoaXMuZml0VG9Db250YWluZXIodGhpcy5zaWduYXR1cmVjYW52YXMubmF0aXZlRWxlbWVudCwgZG9jdW1lbnQuYm9keS5jbGllbnRIZWlnaHQsIGRvY3VtZW50LmJvZHkuY2xpZW50V2lkdGgpO1xuXHRcdFx0XHR0aGlzLmNsZWFyQ2FudmFzKCk7XG5cdFx0XHRcdHRoaXMuZHJhd0Zyb21TYXZlZERhdGEodGhpcy5zYXZlZERhdGFQb2ludHMpO1xuXHRcdFx0XHR0aGlzLmltYWdlU3JjRGF0YVVybCA9IHRoaXMuc2lnbmF0dXJlUGFkLnRvRGF0YVVSTCgpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9XG5cblx0c2F2ZUZyb21TYXZlZERhdGEodmFsKSB7XG5cdFx0dGhpcy51cGRhdGVQcmV2aW91c1NhdmVEYXRhKHZhbCk7XG5cdFx0dGhpcy5kcmF3RnJvbVNhdmVkRGF0YSh2YWwpO1xuXHRcdHRoaXMuc2F2ZWREYXRhUG9pbnRzID0gdGhpcy5zaWduYXR1cmVQYWQudG9EYXRhKCk7XG5cdH1cblxuXHRjcmVhdGVDYW52YXMoKSB7XG5cdFx0dGhpcy5maXRUb0NvbnRhaW5lcih0aGlzLnNpZ25hdHVyZWNhbnZhcy5uYXRpdmVFbGVtZW50KTtcblx0XHR0aGlzLnNpZ25hdHVyZVBhZCA9IG5ldyBzaWduaW5nLmRlZmF1bHQodGhpcy5zaWduYXR1cmVjYW52YXMubmF0aXZlRWxlbWVudCwgdGhpcy5hc3NpZ25PcHRpb25zKCkpO1xuXHR9XG5cblx0c2F2ZUNhdmFzKCkge1xuXHRcdGlmICh0aGlzLnNpZ25hdHVyZVBhZCkge1xuXHRcdFx0aWYgKHRoaXMuc2lnbmF0dXJlUGFkLmlzRW1wdHkoKSkge1xuXHRcdFx0XHR0aGlzLmNsZWFyQ2FudmFzKCk7XG5cdFx0XHR9XG5cdFx0XHR0aGlzLmltYWdlRGF0YUNoYW5nZS5lbWl0KEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy5zaWduYXR1cmVQYWQudG9EYXRhKCkpKSk7XG5cdFx0XHR0aGlzLmltYWdlRGF0YVVybC5lbWl0KHRoaXMuc2lnbmF0dXJlUGFkLnRvRGF0YVVSTCgpKTtcblx0XHRcdGlmICh0aGlzLm1vZGUgIT09ICdyZXNwb25zaXZlJykge1xuXHRcdFx0XHR0aGlzLmhpZGVDYW52YXMoKTtcblx0XHRcdFx0dGhpcy5pbWFnZVNyY0RhdGFVcmwgPSB0aGlzLnNpZ25hdHVyZVBhZC50b0RhdGFVUkwoKTtcblx0XHRcdH1cblx0XHRcdHRoaXMuc2F2ZUZyb21TYXZlZERhdGEodGhpcy5zaWduYXR1cmVQYWQudG9EYXRhKCkpO1xuXHRcdH1cblx0fVxuXG5cdGNsZWFyQ2FudmFzKCkge1xuXHRcdHRoaXMuc2lnbmF0dXJlUGFkLmNsZWFyKCk7XG5cdH1cblxuXHR1bmRvQ2FudmFzKCkge1xuXHRcdGNvbnN0IGRhdGEgPSB0aGlzLnNpZ25hdHVyZVBhZC50b0RhdGEoKTtcblxuXHRcdGlmIChkYXRhKSB7XG5cdFx0XHRkYXRhLnBvcCgpOyAvLyByZW1vdmUgdGhlIGxhc3QgZG90IG9yIGxpbmVcblx0XHRcdHRoaXMuc2lnbmF0dXJlUGFkLmZyb21EYXRhKGRhdGEpO1xuXHRcdH1cblx0fVxuXG5cdHNob3dDYW52YXMoKSB7XG5cdFx0dGhpcy5jbGFzc0FicyA9IHRydWU7XG5cdFx0dGhpcy5jYW52YXNNb2RlID0gJ2Z1bGxzY3JlZW4nO1xuXHRcdGlmICghdGhpcy5zaWduYXR1cmVQYWQpIHtcblx0XHRcdHRoaXMuY3JlYXRlQ2FudmFzKCk7XG5cdFx0fVxuXHRcdHRoaXMuZml0VG9Db250YWluZXIodGhpcy5zaWduYXR1cmVjYW52YXMubmF0aXZlRWxlbWVudCwgZG9jdW1lbnQuYm9keS5jbGllbnRIZWlnaHQsIGRvY3VtZW50LmJvZHkuY2xpZW50V2lkdGgpO1xuXHRcdHRoaXMuY2xlYXJDYW52YXMoKTtcblx0XHR0aGlzLnVwZGF0ZVByZXZpb3VzU2F2ZURhdGEodGhpcy5zYXZlZERhdGFQb2ludHMpO1xuXHRcdHRoaXMuZHJhd0Zyb21TYXZlZERhdGEodGhpcy5zYXZlZERhdGFQb2ludHMpO1xuXHR9XG5cblx0aGlkZUNhbnZhcygpIHtcblx0XHR0aGlzLmNhbnZhc01vZGUgPSAncmVzcG9uc2l2ZSc7XG5cdH1cblxuXHQvLyBjYW5jZWwgY3VycmVudGx5IGRyYXduXG5cdGNhbmNlbCgpIHtcblx0XHR0aGlzLnNhdmVkRGF0YVBvaW50cyA9IE9iamVjdC5hc3NpZ24oW10sIHRoaXMucHJldmlvdXNTYXZlZERhdGEpO1xuXHRcdHRoaXMuY2xlYXJDYW52YXMoKTtcblx0XHR0aGlzLmRyYXdGcm9tU2F2ZWREYXRhKHRoaXMuc2F2ZWREYXRhUG9pbnRzKTtcblx0fVxuXG5cdHVwZGF0ZVByZXZpb3VzU2F2ZURhdGEodmFsKSB7XG5cdFx0dGhpcy5wcmV2aW91c1NhdmVkRGF0YSA9IE9iamVjdC5hc3NpZ24oW10sIHZhbCk7XG5cdH1cblxuXHRkcmF3RnJvbVNhdmVkRGF0YSh2YWwpIHtcblx0XHRpZiAodmFsKSB7XG5cdFx0XHR0aGlzLnNpZ25hdHVyZVBhZC5jbGVhcigpO1xuXHRcdFx0dGhpcy5zaWduYXR1cmVQYWQuZnJvbURhdGEodmFsKTtcblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIGZpdFRvQ29udGFpbmVyKGVsZW1lbnQsIGhlaWdodD8sIHdpZHRoPykge1xuXHRcdGVsZW1lbnQuc3R5bGUud2lkdGggPSAnMTAwJSc7XG5cdFx0ZWxlbWVudC5zdHlsZS5oZWlnaHQgPSAnY2FsYygxMDAlIC0gNTZweCknO1xuXHRcdGlmIChoZWlnaHQgJiYgd2lkdGgpIHtcblx0XHRcdGVsZW1lbnQud2lkdGggPSB3aWR0aDtcblx0XHRcdGVsZW1lbnQuaGVpZ2h0ID0gaGVpZ2h0IC0gNTY7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGVsZW1lbnQud2lkdGggPSBlbGVtZW50Lm9mZnNldFdpZHRoO1xuXHRcdFx0ZWxlbWVudC5oZWlnaHQgPSBlbGVtZW50Lm9mZnNldEhlaWdodDtcblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIGFzc2lnbk9wdGlvbnMoKSB7XG5cdFx0bGV0IG9wdGlvbnMgPSB7fTtcblx0XHRvcHRpb25zWydiYWNrZ3JvdW5kQ29sb3InXSA9IHRoaXMuY2hlY2tJZlZhbGlkVmFsdWVBbmRSR0IodGhpcy5iYWNrZ3JvdW5kQ29sb3IsICdiYWNrZ3JvdW5kQ29sb3InKTtcblx0XHRvcHRpb25zWydkb3RTaXplJ10gPSB0aGlzLmNoZWNrSWZWYWxpZFZhbHVlQW5kTnVtYmVyKHRoaXMuZG90U2l6ZSwgJ2RvdFNpemUnKTtcblx0XHRvcHRpb25zWydtaW5XaWR0aCddID0gdGhpcy5jaGVja0lmVmFsaWRWYWx1ZUFuZE51bWJlcih0aGlzLm1pbldpZHRoLCAnbWluV2lkdGgnKTtcblx0XHRvcHRpb25zWydtYXhXaWR0aCddID0gdGhpcy5jaGVja0lmVmFsaWRWYWx1ZUFuZE51bWJlcih0aGlzLm1heFdpZHRoLCAnbWF4V2lkdGgnKTtcblx0XHRvcHRpb25zWyd0aHJvdHRsZSddID0gdGhpcy5jaGVja0lmVmFsaWRWYWx1ZUFuZE51bWJlcih0aGlzLnRocm90dGxlLCAndGhyb3R0bGUnKTtcblx0XHRvcHRpb25zWydtaW5EaXN0YW5jZSddID0gdGhpcy5jaGVja0lmVmFsaWRWYWx1ZUFuZE51bWJlcih0aGlzLm1pbkRpc3RhbmNlLCAnbWluRGlzdGFuY2UnKTtcblx0XHRvcHRpb25zWydwZW5Db2xvciddID0gdGhpcy5jaGVja0lmVmFsaWRWYWx1ZUFuZFJHQih0aGlzLnBlbkNvbG9yLCAncGVuQ29sb3InKTtcblx0XHRvcHRpb25zWyd2ZWxvY2l0eUZpbHRlcldlaWdodCddID0gdGhpcy5jaGVja0lmVmFsaWRWYWx1ZUFuZE51bWJlcih0aGlzLnZlbG9jaXR5RmlsdGVyV2VpZ2h0LCAndmVsb2NpdHlGaWx0ZXJXZWlnaHQnKTtcblx0XHRvcHRpb25zID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShvcHRpb25zKSk7IC8vIHJlbW92aW5nIGFsbCB1bmRlZmluZWQgZmllbGRzXG5cdFx0b3B0aW9uc1snb25CZWdpbiddID0gdGhpcy5jaGVja0lmVmFsaWRWYWx1ZUFuZEZ1bmN0aW9uKHRoaXMub25CZWdpbiwgJ29uQmVnaW4nKTtcblx0XHRvcHRpb25zWydvbkVuZCddID0gdGhpcy5jaGVja0lmVmFsaWRWYWx1ZUFuZEZ1bmN0aW9uKHRoaXMub25FbmQsICdvbkVuZCcpO1xuXHRcdHJldHVybiBvcHRpb25zO1xuXHR9XG5cblx0cHJpdmF0ZSBjaGVja0lmVmFsaWRWYWx1ZUFuZE51bWJlcihudW0sIG5hbWUpIHtcblx0XHRpZiAodGhpcy5jaGVja0lmVmFsaWQobnVtKSAmJiB0aGlzLmNoZWNrTnVtYmVyKG51bSkpIHtcblx0XHRcdHJldHVybiBudW07XG5cdFx0fVxuXHRcdHRoaXMuaW52YWxpZFRvYXN0KG5hbWUsICdudW0nKTtcblx0XHRyZXR1cm4gdW5kZWZpbmVkO1xuXHR9XG5cblx0cHJpdmF0ZSBjaGVja0lmVmFsaWRWYWx1ZUFuZFJHQihjb2xvciwgbmFtZSkge1xuXHRcdGlmICh0aGlzLmNoZWNrSWZWYWxpZChjb2xvcikgJiYgdGhpcy5jaGVja1JHQihjb2xvcikpIHtcblx0XHRcdHJldHVybiBjb2xvcjtcblx0XHR9XG5cdFx0dGhpcy5pbnZhbGlkVG9hc3QobmFtZSwgJ3JnYicpO1xuXHRcdHJldHVybiB1bmRlZmluZWQ7XG5cdH1cblxuXHRwcml2YXRlIGNoZWNrSWZWYWxpZFZhbHVlQW5kRnVuY3Rpb24oZm4sIG5hbWUpIHtcblx0XHRpZiAodGhpcy5jaGVja0lmVmFsaWQoZm4pICYmIHRoaXMuY2hlY2tJZlZhbGlkRnVuY3Rpb24oZm4pKSB7XG5cdFx0XHRyZXR1cm4gZm47XG5cdFx0fVxuXHRcdHRoaXMuaW52YWxpZFRvYXN0KG5hbWUsICdmdW5jdGlvbiBmb3JtYXQnKTtcblx0XHRyZXR1cm4gdW5kZWZpbmVkO1xuXHR9XG5cblx0cHJpdmF0ZSBjaGVja0lmVmFsaWQodmFsdWUpIHtcblx0XHRyZXR1cm4gdmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gbnVsbCA/IHZhbHVlIDogdW5kZWZpbmVkO1xuXHR9XG5cblx0cHJpdmF0ZSBjaGVja051bWJlcihudW0pIHtcblx0XHRyZXR1cm4gIXRoaXMuY2hlY2tJc05hbihOdW1iZXIobnVtKSkgPyBOdW1iZXIobnVtKSA6IHVuZGVmaW5lZDtcblx0fVxuXG5cdHByaXZhdGUgY2hlY2tJZlZhbGlkRnVuY3Rpb24oZm4pIHtcblx0XHRyZXR1cm4gdHlwZW9mIGZuID09PSAnZnVuY3Rpb24nID8gZm4gOiB1bmRlZmluZWQ7XG5cdH1cblxuXHRwcml2YXRlIGNoZWNrUkdCKGNvbG9yKSB7XG5cdFx0Y29uc3QgbWF0Y2hDb2xvcnMxID0gbmV3IFJlZ0V4cCgvcmdiXFwoKFxcZHsxLDN9KSwoXFxkezEsM30pLChcXGR7MSwzfSlcXCkvKTtcblx0XHRjb25zdCBtYXRjaENvbG9yczIgPSBuZXcgUmVnRXhwKC9yZ2JcXCgoXFxkezEsM30pLFsgXFx0XSsoXFxkezEsM30pLChcXGR7MSwzfSlcXCkvKTtcblx0XHRjb25zdCBtYXRjaENvbG9yczMgPSBuZXcgUmVnRXhwKC9yZ2JcXCgoXFxkezEsM30pLChcXGR7MSwzfSksWyBcXHRdKyhcXGR7MSwzfSlcXCkvKTtcblx0XHRyZXR1cm4gbWF0Y2hDb2xvcnMxLnRlc3QoY29sb3IpIHx8IG1hdGNoQ29sb3JzMi50ZXN0KGNvbG9yKSB8fCBtYXRjaENvbG9yczMudGVzdChjb2xvcik7XG5cdH1cblxuXHRwcml2YXRlIGNoZWNrSXNOYW4odmFsdWUpIHtcblx0XHRyZXR1cm4gTnVtYmVyLmlzTmFOKHZhbHVlKTtcblx0fVxuXG5cdHByaXZhdGUgaW52YWxpZFRvYXN0KG9wdGlvbk5hbWUsIG9wdGlvblR5cGUpIHtcblx0XHRzd2l0Y2ggKG9wdGlvblR5cGUpIHtcblx0XHRcdGNhc2UgJ251bSc6XG5cdFx0XHRcdC8vIHRoaXMuc25hY2tiYXIub3BlbihgSW52YWxpZCAke29wdGlvbk5hbWV9IChudW1iZXIgb3IgZmxvYXQpIGdpdmVuLCB0YWtpbmcgZGVmYXVsdCB2YWx1ZSBpbnN0ZWFkLmAsICdPSycpO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgJ3JnYic6XG5cdFx0XHRcdC8vIHRoaXMuc25hY2tiYXIub3BlbihgSW52YWxpZCAke29wdGlvbk5hbWV9IGZvcm1hdCBFZzogcmdiKDI1NSwgMjU1LCAyNTUpICBnaXZlbiwgdGFraW5nIGRlZmF1bHQgdmFsdWUgaW5zdGVhZC5gLCAnT0snKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0fVxuXHRcdHJldHVybjtcblx0fVxuXG5cdHByaXZhdGUgaXNEYXRhVVJMKHMpIHtcblx0XHRpZiAocyAmJiB0eXBlb2YgcyA9PT0gJ3N0cmluZycpIHtcblx0XHRcdGNvbnN0IHJlZ2V4ID1cblx0XHRcdFx0L15cXHMqZGF0YTooW2Etel0rXFwvW2Etel0rKDtbYS16XFwtXStcXD1bYS16XFwtXSspPyk/KDtiYXNlNjQpPyxbYS16MC05XFwhXFwkXFwmXFwnXFwsXFwoXFwpXFwqXFwrXFwsXFw7XFw9XFwtXFwuXFxfXFx+XFw6XFxAXFwvXFw/XFwlXFxzXSpcXHMqJC9pO1xuXHRcdFx0cmV0dXJuICEhcy5tYXRjaChyZWdleCk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHJldHVybiBmYWxzZTtcblx0XHR9XG5cdH1cbn1cbiJdfQ==